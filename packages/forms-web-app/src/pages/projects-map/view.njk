{% from "govuk/components/warning-text/macro.njk" import govukWarningText %}
{% extends "layouts/default.njk" %}

{% set pageTitle = t('projectsMap.pageTitle') %}

{% block stylesheet %}
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.5.1/ol.css"/>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol-ext@v4.0.37/dist/ol-ext.min.css"/>
	<style>
		.pins-map {
			width: 100%;
			height: 450px;
			min-height: 450px;
		}

		.pins-map__container {
			width: 100%;
			height: 100%;
		}

		/* Tablet */
		@media (min-width: 641px) {
			.pins-map {
				height: 600px;
				min-height: 600px;
			}
		}

		/* Hide toggle button by default (mobile/tablet) */
		#projects-map-filters-toggle-btn {
			display: none;
		}

		/* Desktop */
		@media (min-width: 769px) {
			.pins-map {
				height: 650px;
				min-height: 650px;
			}

			/* Default: content full-width on desktop, sidebar hidden */
			#projects-map-sidebar-column {
				display: none;
			}

			#projects-map-content-column {
				width: 100%;
			}

			/* When grid has show-filters class: 1/3 + 2/3 layout */
			#projects-map-grid.projects-map-grid--show-filters #projects-map-sidebar-column {
				display: block;
				width: 33.33%;
			}

			#projects-map-grid.projects-map-grid--show-filters #projects-map-content-column {
				width: 66.66%;
			}

			/* Show toggle button only on desktop */
			#projects-map-filters-toggle-btn {
				display: inline-block;
			}
		}

		/* Touch-friendly controls */
		@media (hover: none) and (pointer: coarse) {
			.ol-control {
				padding: 6px;
			}

			.ol-control button {
				min-width: 44px;
				min-height: 44px;
			}
		}
	</style>
{% endblock %}

{% block script %}
	<script nonce="{{ cspNonce }}">
		// Debug flag for all page scripts
		window.DEBUG_ENABLED = false;

		/**
		 * Page-level debug logging
		 * Respects DEBUG_ENABLED flag
		 */
		window.pageDebug = function(...args) {
			if (window.DEBUG_ENABLED) {
				console.log(...args);
			}
		};
	</script>

	<script nonce="{{ cspNonce }}">
		/**
		 * Application Service Configuration
		 * Centralized client-side configuration and callbacks
		 */
		window._applicationService = {
			mapConfig: {
				elementId: '{{ mapConfig.elementId }}',
				accessToken: '{{ mapConfig.accessToken }}',
				center: {{ mapConfig.center | dump | safe }},
				zoom: {{ mapConfig.zoom }},
				markers: {{ mapConfig.markers | dump | safe }},
				crs: {{ mapConfig.crs | dump | safe }}
			}
		};
		window.pageDebug('_applicationService initialized:', window._applicationService);
	</script>

	<script nonce="{{ cspNonce }}">
		/**
		 * Desktop toggle functionality for filters sidebar
		 * Only runs on desktop (769px+), mobile/tablet uses modal script
		 */
		(function() {
			const toggleBtn = document.getElementById('projects-map-filters-toggle-btn');
			const gridRow = document.getElementById('projects-map-grid');

			if (!toggleBtn || !gridRow) {
				return;
			}

			toggleBtn.addEventListener('click', function(e) {
				const isShowingFilters = gridRow.classList.toggle('projects-map-grid--show-filters');

				// Update button text
				toggleBtn.textContent = isShowingFilters
					? '{{ t("projectsMap.hideFiltersText") }}'
					: '{{ t("projectsMap.showFiltersText") }}';

				// Trigger map resize
				if (window._applicationService && window._applicationService.map) {
					setTimeout(() => {
						window._applicationService.map.updateSize();
					}, 100);
				}
			});
		})();
	</script>

	{% set initiateScriptsConfig = (initiateScriptsConfig.push(
		{ src: "/public/scripts/checkbox-accordion.script.js" },
		{
			callback: "var modal = new appScripts.modal(); modal.initiate('#projects-map-page-filters', '.ui-checkbox-accordion__modal-close-btn', '#projects-map-search-bar', 'Show filters', 'tablet');",
			src: "/public/scripts/modal.script.js"
		},
		{
			callback: "window.pageDebug('Initiating OpenLayers map'); window.pageDebug('Map config:', window._applicationService.mapConfig); var olMap = new appScripts.openLayersMap(); window.pageDebug('OpenLayers map object created'); olMap.initiate(window._applicationService.mapConfig).then(function() { window.pageDebug('OpenLayers map initiated'); }).catch(function(err) { console.error('OpenLayers map init error:', err); window.pageDebug('OpenLayers map init error:', err); });",
			src: "/public/scripts/openLayersMap.script.js"
		}
	), initiateScriptsConfig) %}
{% endblock %}

{% block content %}
	<form method="post">
		<div class="govuk-grid-row" id="projects-map-grid">
			<div class="govuk-grid-column-one-third" id="projects-map-sidebar-column">
				{% include "./includes/sidebar.njk" %}
			</div>

			<div class="govuk-grid-column-two-thirds" id="projects-map-content-column">
				<h1 class="govuk-heading-xl govuk-!-margin-bottom-4">
					{{ t('projectsMap.heading1') }}
				</h1>

				{% if featureFlag.allowWelshTranslation == false %}
					<p class="govuk-body">
						This is a new service. All English projects can be found in this list. For Welsh projects, visit our <a class="govuk-link" href="{{ pinsURL.index }}">old website</a>.
					</p>
				{% endif %}

				<p class="govuk-body">
					{{ t('projectsMap.paragraph1') }}
				</p>

				{% include "./includes/search.njk" %}

				<div class="govuk-button-group govuk-!-margin-bottom-4">
					<button type="button" id="projects-map-filters-toggle-btn" class="govuk-button govuk-button--secondary">
						{{ t('projectsMap.showFiltersText') }}
					</button>
					<a class="govuk-link" href="{{ projectSearchURL }}">{{ t('projectsMap.projectSearchLinkText') }}</a>
				</div>

				{% include "../project-search/includes/active-filters.njk" %}

				<div class="pins-map govuk-!-margin-bottom-4">
					<div id="projects-map"
						role="main"
						aria-label="{{ t('projectsMap.mapAriaLabel') }}"
						tabindex="0"
						class="pins-map__container"></div>
				</div>

				<p class="govuk-visually-hidden">
					{{ t('projectsMap.mapIntroText', { totalProjects: mapConfig.totalProjects, projectSearchLink: '<a href="' + projectSearchURL + '">' + t('projectsMap.projectSearchText') + '</a>' }) | safe }}
				</p>

				{{ govukWarningText({
					text: t('projectsMap.warningText'),
					iconFallbackText: "Warning"
				}) }}
			</div>
		</div>
	</form>
{% endblock %}
