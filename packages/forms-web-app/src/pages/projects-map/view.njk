{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/warning-text/macro.njk" import govukWarningText %}
{% extends "layouts/default.njk" %}

{% set pageTitle = t('projectsMap.pageTitle') %}

{% set leafletStyles = [
	{
		cdn: 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css',
		local: '/public/stylesheets/leaflet.css'
	},
	{
		cdn: 'https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.min.css',
		local: '/public/stylesheets/MarkerCluster.css'
	},
	{
		cdn: 'https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css',
		local: '/public/stylesheets/MarkerCluster.Default.css'
	}
] %}

{% block stylesheet %}
	{% for style in leafletStyles %}
		<link rel="stylesheet" href="{{ style.cdn }}"/>
	{% endfor %}
	<link rel="stylesheet" href="/public/stylesheets/projects-map.css"/>
	<script nonce="{{ cspNonce }}">
		function loadLocalStylesheet(url) {
			const link = document.createElement('link');
			link.rel = 'stylesheet';
			link.href = url;
			document.head.appendChild(link);
		}

		const stylesheets = [
			{% for style in leafletStyles %}
			{ cdn: '{{ style.cdn }}', local: '{{ style.local }}' }{{ "," if not loop.last }}
			{% endfor %}
		];

		stylesheets.forEach((sheet) => {
			const link = document.querySelector(`link[href="${sheet.cdn}"]`);
			if (link) {
				link.onerror = () => {
					loadLocalStylesheet(sheet.local);
				};
			}
		});
	</script>
{% endblock %}

{% block content %}
	<div class="govuk-grid-row">
		<aside class="govuk-grid-column-one-third govuk-!-display-none" id="maps-sidebar-content" aria-label="Project filters">
			<form method="post">
				{% include "./includes/sidebar.njk" %}
			</form>
		</aside>

		<div class="govuk-grid-column-full" id="maps-content">
			<h1 class="govuk-heading-xl govuk-!-margin-bottom-4">
				{{ t('projectsMap.heading1') }}
			</h1>

			{% if featureFlag.allowWelshTranslation == false %}
				<p class="govuk-body">
					This is a new service. All English projects can be found in this list. For Welsh projects, visit our <a class="govuk-link" href="{{ pinsURL.index }}">old website</a>.
				</p>
			{% endif %}

			<p class="govuk-body">
				{{ t('projectsMap.paragraph1') }}
			</p>

			<div class="govuk-button-group">
				{{ govukButton({
					text: t('projectsMap.showFiltersText'),
					classes: "govuk-button--secondary",
					attributes: {
						id: "filters-toggle-btn",
						'data-sidebar-toggle': '#maps-sidebar-content',
						'data-content-toggle': '#maps-content',
						'data-toggle-class': 'govuk-!-display-none',
						'data-content-hidden-class': 'govuk-grid-column-full',
						'data-content-visible-class': 'govuk-grid-column-two-thirds',
						'data-show-label': t('projectsMap.showFiltersText'),
						'data-hide-label': t('projectsMap.hideFiltersText'),
						'data-on-toggle': '_applicationService.onSidebarToggle',
						'aria-expanded': 'false',
						'aria-controls': 'maps-sidebar-content'
					}
				}) }}
				<a class="govuk-link" href="{{ projectSearchURL }}">{{ t('projectsMap.projectSearchLinkText') }}</a>
			</div>

			<form method="post">
				{% include "../project-search/includes/search.njk" %}
			</form>

			{% include "../project-search/includes/active-filters.njk" %}

			<div id="projects-map"
				role="main"
				aria-label="{{ t('projectsMap.mapAriaLabel') }}"
				tabindex="0"
				class="govuk-!-margin-bottom-4"></div>

			<p class="govuk-visually-hidden">
				{{ t('projectsMap.mapIntroText', { totalProjects: mapConfig.totalProjects, projectSearchLink: '<a href="' + projectSearchURL + '">' + t('projectsMap.projectSearchText') + '</a>' }) | safe }}
			</p>

			{{ govukWarningText({
				text: t('projectsMap.warningText'),
				iconFallbackText: "Warning"
			}) }}
		</div>
	</div>
{% endblock %}

{% block script %}
	<script nonce="{{ cspNonce }}">
		// Debug flag for all page scripts
		window.DEBUG_ENABLED = false;

		/**
		 * Page-level debug logging
		 * Respects DEBUG_ENABLED flag
		 */
		window.pageDebug = function(...args) {
			if (window.DEBUG_ENABLED) {
				console.log(...args);
			}
		};
	</script>

	<script nonce="{{ cspNonce }}">
		/**
		 * Application Service Configuration
		 * Centralized client-side configuration and callbacks
		 */
		window._applicationService = {
			mapConfig: {
				elementId: '{{ mapConfig.elementId }}',
				mapOptions: {{ mapConfig.mapOptions | dump | safe }},
				tileLayer: {{ mapConfig.tileLayer | dump | safe }},
				crs: {{ mapConfig.crs | dump | safe }},
				markers: {{ mapConfig.markers | dump | safe }},
				clustered: {{ mapConfig.clustered | dump | safe }},
				totalProjects: {{ mapConfig.totalProjects }},
				hasActiveFilters: {{ mapConfig.hasActiveFilters | dump | safe }},
				animateWhenZoomed: {{ mapConfig.animateWhenZoomed | dump | safe }}
			},
			/**
			 * Callback when sidebar toggles
			 */
			onSidebarToggle: function(state) {
				var map = window._applicationService.map;
				var mapStateManager = window._applicationService.mapStateManager;
				if (!map || !mapStateManager || !state.content) return;
				mapStateManager.handleContainerResize(state.content);
			}
		};
		window.pageDebug('_applicationService initialized:', window._applicationService);
	</script>
	{% set initiateScriptsConfig = (initiateScriptsConfig.push(
		{ src: "/public/scripts/checkbox-accordion.script.js" },
		{
			callback: "var modal = new appScripts.modal(); modal.initiate('#projects-map-page-filters', '.ui-checkbox-accordion__modal-close-btn', '#projects-map-search-bar', 'Show filters', 'tablet');",
			src: "/public/scripts/modal.script.js"
		},
		{
			callback: "window.pageDebug('Initiating sidebar toggler'); var toggler = new appScripts.sidebarToggler('#filters-toggle-btn'); toggler.initiate().then(function() { window.pageDebug('Sidebar toggler initiated'); }).catch(function(err) { window.pageDebug('Sidebar toggler init error:', err); });",
			src: "/public/scripts/sidebarToggler.script.js"
		},
		{
			callback: "window.pageDebug('Initiating leaflet map'); var leafletMap = new appScripts.leafletMap(); window.pageDebug('Leaflet map object created'); leafletMap.initiate(window._applicationService.mapConfig).then(function() { window.pageDebug('Leaflet map initiated'); }).catch(function(err) { window.pageDebug('Leaflet map init error:', err); });",
			src: "/public/scripts/leafletMap.script.js"
		}
	), initiateScriptsConfig) %}
{% endblock %}
