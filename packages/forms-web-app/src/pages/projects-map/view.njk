{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/warning-text/macro.njk" import govukWarningText %}
{% extends "layouts/default.njk" %}

{% set pageTitle = t('projectsMap.pageTitle') %}

{% block stylesheet %}
	<link rel="stylesheet" href="/public/stylesheets/leaflet.css"/>
	<link rel="stylesheet" href="/public/stylesheets/MarkerCluster.css"/>
	<link rel="stylesheet" href="/public/stylesheets/MarkerCluster.Default.css"/>
	<link rel="stylesheet" href="/public/stylesheets/leaflet-pins.css">
{% endblock %}

{% block content %}
	<div class="govuk-grid-row">
		<div class="govuk-grid-column-one-third" id="maps-sidebar-content">
			Filter goes here
		</div>

		<div class="govuk-grid-column-two-thirds" id="maps-content">
			<h1 class="govuk-heading-xl govuk-!-margin-bottom-4">
				{{ t('projectsMap.heading1') }}
			</h1>

			{% if featureFlag.allowWelshTranslation == false %}
				<p class="govuk-body">
					This is a new service. All English projects can be found in this list. For Welsh projects, visit our <a class="govuk-link" href="{{ pinsURL.index }}">old website</a>.
				</p>
			{% endif %}

			<p class="govuk-body">
				{{ t('projectsMap.paragraph1') }}
			</p>

			{% include "../project-search/includes/search.njk" %}

			<div class="govuk-button-group">
				{{ govukButton({
					text: t('projectsMap.hideFiltersText'),
					classes: "govuk-button--secondary",
					attributes: {
						id: "filters-toggle-btn",
						'data-sidebar-toggle': '#maps-sidebar-content',
						'data-content-toggle': '#maps-content',
						'data-toggle-class': 'govuk-!-display-none',
						'data-content-hidden-class': 'govuk-grid-column-full',
						'data-content-visible-class': 'govuk-grid-column-two-thirds',
						'data-show-label': t('projectsMap.showFiltersText'),
						'data-hide-label': t('projectsMap.hideFiltersText'),
						'data-on-toggle': '_applicationService.onSidebarToggle'
					}
				}) }}
				<a class="govuk-link" href="{{ projectSearchURL }}">{{ t('projectsMap.projectSearchLinkText') }}</a>
			</div>

			<div id="map" class="govuk-!-margin-bottom-4" style="height: 550px;"></div>

			{% include "../project-search/includes/active-filters.njk" %}

			{{ govukWarningText({
				text: t('projectsMap.warningText'),
				iconFallbackText: "Warning"
			}) }}
		</div>
	</div>
{% endblock %}

{% block script %}
	<script nonce="{{ cspNonce }}">
		// Debug flag for all page scripts
		window.DEBUG_ENABLED = false;

		/**
		 * Page-level debug logging
		 * Respects DEBUG_ENABLED flag
		 */
		window.pageDebug = function(...args) {
			if (window.DEBUG_ENABLED) {
				console.log(...args);
			}
		};
	</script>

	<script nonce="{{ cspNonce }}">
		/**
		 * Application Service Configuration
		 * Centralizes all client-side configuration and callbacks
		 */
		window._applicationService = {
			mapConfig: {
				elementId: '{{ mapConfig.elementId }}',
				mapOptions: {{ mapConfig.mapOptions | dump | safe }},
				tileLayer: {{ mapConfig.tileLayer | dump | safe }},
				markers: {{ mapConfig.markers | dump | safe }},
				clustered: {{ mapConfig.clustered | dump | safe }},
				totalProjects: {{ mapConfig.totalProjects }}
			},
			/**
			 * Callback when sidebar toggles
			 * Preserves map bounds during layout changes
			 */
			onSidebarToggle: function(state) {
				var map = window._applicationService.map;
				var mapStateManager = window._applicationService.mapStateManager;
				if (!map || !mapStateManager || !state.content) return;
				
				var bounds = map.getBounds();
				mapStateManager.handleContainerResize(state.content, bounds);
			}
		};
		window.pageDebug('_applicationService initialized:', window._applicationService);
	</script>
	{% set initiateScriptsConfig = (initiateScriptsConfig.push(
		{
			callback: "window.pageDebug('Initiating sidebar toggler'); var toggler = new window.SidebarToggler('#filters-toggle-btn'); toggler.initiate().then(function() { window.pageDebug('Sidebar toggler initiated'); }).catch(function(err) { window.pageDebug('Sidebar toggler init error:', err); });",
			src: "/public/scripts/sidebarToggler.script.js"
		},
		{
			callback: "window.pageDebug('Initiating leaflet map'); var leafletMap = new appScripts.leafletMap(); window.pageDebug('Leaflet map object created'); leafletMap.initiate(window._applicationService.mapConfig).then(function() { window.pageDebug('Leaflet map initiated'); }).catch(function(err) { window.pageDebug('Leaflet map init error:', err); });",
			src: "/public/scripts/leafletMap.script.js"
		}
	), initiateScriptsConfig) %}
{% endblock %}
