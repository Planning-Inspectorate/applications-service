{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/warning-text/macro.njk" import govukWarningText %}
{% extends "layouts/default.njk" %}

{% set pageTitle = t('projectsMap.pageTitle') %}

{% block stylesheet %}
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.5.1/ol.css"/>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol-ext@v4.0.37/dist/ol-ext.min.css"/>
	<style>
		.pins-map {
			width: 100%;
			height: 450px;
			min-height: 450px;
		}

		.pins-map__container {
			width: 100%;
			height: 100%;
		}

		/* Tablet */
		@media (min-width: 641px) {
			.pins-map {
				height: 600px;
				min-height: 600px;
			}
		}

		/* Desktop */
		@media (min-width: 769px) {
			.pins-map {
				height: 650px;
				min-height: 650px;
			}
		}

		/* Touch-friendly controls */
		@media (hover: none) and (pointer: coarse) {
			.ol-control {
				padding: 6px;
			}

			.ol-control button {
				min-width: 44px;
				min-height: 44px;
			}
		}
	</style>

{% endblock %}

{% block content %}
	<div class="govuk-grid-row">
		<aside class="govuk-grid-column-one-third govuk-!-display-none" id="maps-sidebar-content" aria-label="Project filters">
			<form method="post">
				{% include "./includes/sidebar.njk" %}
			</form>
		</aside>

		<div class="govuk-grid-column-full" id="maps-content">
			<h1 class="govuk-heading-xl govuk-!-margin-bottom-4">
				{{ t('projectsMap.heading1') }}
			</h1>

			{% if featureFlag.allowWelshTranslation == false %}
				<p class="govuk-body">
					This is a new service. All English projects can be found in this list. For Welsh projects, visit our <a class="govuk-link" href="{{ pinsURL.index }}">old website</a>.
				</p>
			{% endif %}

			<p class="govuk-body">
				{{ t('projectsMap.paragraph1') }}
			</p>

			<div class="govuk-button-group">
				{{ govukButton({
					text: t('projectsMap.showFiltersText'),
					classes: "govuk-button--secondary",
					attributes: {
						id: "filters-toggle-btn",
						'data-sidebar-toggle': '#maps-sidebar-content',
						'data-content-toggle': '#maps-content',
						'data-toggle-class': 'govuk-!-display-none',
						'data-content-hidden-class': 'govuk-grid-column-full',
						'data-content-visible-class': 'govuk-grid-column-two-thirds',
						'data-show-label': t('projectsMap.showFiltersText'),
						'data-hide-label': t('projectsMap.hideFiltersText'),
						'data-on-toggle': '_applicationService.onSidebarToggle',
						'aria-expanded': 'false',
						'aria-controls': 'maps-sidebar-content'
					}
				}) }}
				<a class="govuk-link" href="{{ projectSearchURL }}">{{ t('projectsMap.projectSearchLinkText') }}</a>
			</div>

			<form method="post">
				{% include "../project-search/includes/search.njk" %}
			</form>

			{% include "../project-search/includes/active-filters.njk" %}

			<div class="pins-map govuk-!-margin-bottom-4">
				<div id="projects-map"
					role="main"
					aria-label="{{ t('projectsMap.mapAriaLabel') }}"
					tabindex="0"
					class="pins-map__container"></div>
			</div>

			<p class="govuk-visually-hidden">
				{{ t('projectsMap.mapIntroText', { totalProjects: mapConfig.totalProjects, projectSearchLink: '<a href="' + projectSearchURL + '">' + t('projectsMap.projectSearchText') + '</a>' }) | safe }}
			</p>

			{{ govukWarningText({
				text: t('projectsMap.warningText'),
				iconFallbackText: "Warning"
			}) }}
		</div>
	</div>
{% endblock %}

{% block script %}
	<script nonce="{{ cspNonce }}">
		// Debug flag for all page scripts
		window.DEBUG_ENABLED = false;

		/**
		 * Page-level debug logging
		 * Respects DEBUG_ENABLED flag
		 */
		window.pageDebug = function(...args) {
			if (window.DEBUG_ENABLED) {
				console.log(...args);
			}
		};
	</script>

	<script nonce="{{ cspNonce }}">
		/**
		 * Application Service Configuration
		 * Centralized client-side configuration and callbacks
		 */
		window._applicationService = {
			mapConfig: {
				elementId: '{{ mapConfig.elementId }}',
				accessToken: '{{ mapConfig.accessToken }}',
				center: {{ mapConfig.center | dump | safe }},
				zoom: {{ mapConfig.zoom }},
				markers: {{ mapConfig.markers | dump | safe }},
				crs: {{ mapConfig.crs | dump | safe }}
			},
			/**
			 * Callback when sidebar toggles
			 */
			onSidebarToggle: function(state) {
				var map = window._applicationService.map;
				var mapStateManager = window._applicationService.mapStateManager;
				if (!map || !mapStateManager || !state.content) return;
				mapStateManager.handleContainerResize(state.content);
			}
		};
		window.pageDebug('_applicationService initialized:', window._applicationService);
	</script>
	{% set initiateScriptsConfig = (initiateScriptsConfig.push(
		{ src: "/public/scripts/checkbox-accordion.script.js" },
		{
			callback: "var modal = new appScripts.modal(); modal.initiate('#projects-map-page-filters', '.ui-checkbox-accordion__modal-close-btn', '#projects-map-search-bar', 'Show filters', 'tablet');",
			src: "/public/scripts/modal.script.js"
		},
		{
			callback: "window.pageDebug('Initiating sidebar toggler'); var toggler = new appScripts.sidebarToggler('#filters-toggle-btn'); toggler.initiate().then(function() { window.pageDebug('Sidebar toggler initiated'); }).catch(function(err) { window.pageDebug('Sidebar toggler init error:', err); });",
			src: "/public/scripts/sidebarToggler.script.js"
		},
		{
			callback: "window.pageDebug('Initiating OpenLayers map'); window.pageDebug('Map config:', window._applicationService.mapConfig); var olMap = new appScripts.openLayersMap(); window.pageDebug('OpenLayers map object created'); olMap.initiate(window._applicationService.mapConfig).then(function() { window.pageDebug('OpenLayers map initiated'); }).catch(function(err) { console.error('OpenLayers map init error:', err); window.pageDebug('OpenLayers map init error:', err); });",
			src: "/public/scripts/openLayersMap.script.js"
		}
	), initiateScriptsConfig) %}
{% endblock %}
