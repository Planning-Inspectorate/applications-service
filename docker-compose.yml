# Port ranges (by convention):
#  - API: 3000-3999
#  - Services: 4000-4999
#  - Mocks: 5000-5999
#  - Documentation: 7000-7999
#  - Websites: 9000-9999
#
# Please run `make install` to get the dependencies install

version: '3.7'
services:
  redis:
    image: redis:6.2.5-alpine
    ports:
      - '6379:6379'

  applications-service-api:
    image: node:14-alpine
    environment:
      APP_APPLICATIONS_BASE_URL: http://forms-web-app:9004
      DOCS_API_PATH: /opt/app/api
      DOCUMENTS_SERVICE_API_URL: http://document-service-api:3000
      LOGGER_LEVEL: 'debug'
      SERVER_SHOW_ERRORS: 'true'
      TRIALIST_DATA_PATH: /opt/app/data/trialists.json
      NODE_ENV: local
      MYSQL_USERNAME: pins
      MYSQL_PASSWORD: pins
      MYSQL_DATABASE: ipclive
      MYSQL_HOST: db
      MYSQL_PORT: 3306
      MYSQL_DIALECT: mysql
      DOCUMENTS_PER_PAGE: '20'
      DOCUMENTS_HOST: https://nitestaz.planninginspectorate.gov.uk/wp-content/ipc/uploads/projects/
      SRV_NOTIFY_BASE_URL: https://api.notifications.service.gov.uk/
      SRV_NOTIFY_SERVICE_ID: '9b89eb93-3071-432c-9c6b-4e07dbda9071'
      SRV_NOTIFY_API_KEY:  'applicationsservice-9b89eb93-3071-432c-9c6b-4e07dbda9071-101fa83a-8d08-40af-92b6-246b95074e5a'
      SRV_NOTIFY_IP_REGISTRATION_CONFIRMATION_EMAIL_TO_IP: '830c9c01-1f81-4198-be72-11ab173c128a'
      PRELIMINARY_MEETING_URL: https://applications-service-web-app.azurewebsites.net/
      HAVING_YOUR_SAY_URL: https://applications-service-web-app.azurewebsites.net/
      SRV_NOTIFY_MAGIC_LINK_EMAIL: '4ca6b93a-4c45-4abe-a8ea-69ba13c80915'
      MAGIC_LINK_DOMAIN: http://localhost:9004/
      ENCRYPTION_SECRET_KEY: 'x!A%C*F-JaNdRgUkXp2s5v8y/B?E(G+K'
    ports:
      - '3000:3000'
    working_dir: '/opt/app'
    volumes:
      - './packages/applications-service-api:/opt/app:ro'
    command: 'npm run start:dev'

  forms-web-app:
    image: node:14-alpine
    environment:
      APPLICATIONS_SERVICE_API_URL: 'http://applications-service-api:3000'
      DOCUMENTS_SERVICE_API_URL: 'http://document-service-api:3000'
      FILE_UPLOAD_DEBUG: 'false'
      FILE_UPLOAD_MAX_FILE_SIZE_BYTES: '15000000'
      FILE_UPLOAD_USE_TEMP_FILES: 'true'
      FILE_UPLOAD_TMP_PATH: '/tmp'
      GOOGLE_ANALYTICS_ID: 'G-X21W2S2FN3'
      SESSION_KEY: some_secure_key_goes_here
      # please override this locally if using not using localhost or ip address to browse the site in dev.
      SUBDOMAIN_OFFSET: '0'
      USE_SECURE_SESSION_COOKIES: 'false'
      PDF_SERVICE_API_URL: 'http://pdf-service-api:3000'
      HOST_URL: 'http://localhost:9004/'
      REDIS_URL: 'redis://redis:6379'
      PRIVATE_BETA_V1_ROUTES_ONLY: 'false'
      FEATURE_REDIS_SESSION_STORE: 'true'
    ports:
      - '9004:3000'
      # node debugger
      # - 9229:9229
    working_dir: '/opt/app'
    links:
      - 'applications-service-api'
    depends_on:
      - 'applications-service-api'
    volumes:
      - ./packages/common:/opt/app/node_modules/@pins/common
      - './packages/forms-web-app:/opt/app'
    command: 'npm run start:dev'
    # if enabling debug, be sure to uncomment / expose the debug port above.
    # command: npm run start:dev:debug

  db:
    image: 'mysql'
    cap_add:
      - SYS_NICE # CAP_SYS_NICE
    command: '--default-authentication-plugin=mysql_native_password'
    restart: 'always'
    environment:
      MYSQL_ROOT_PASSWORD: 'root'
      MYSQL_DATABASE: 'ipclive'
      MYSQL_USER: 'pins'
      MYSQL_PASSWORD: 'pins'
      MYSQL_ROOT_HOST: '%'
    ports:
      - '3306:3306'
    volumes:
      - './init:/docker-entrypoint-initdb.d'

  adminer:
    image: 'adminer'
    restart: 'always'
    ports:
      - '9000:8080'
