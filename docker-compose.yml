# Port ranges (by convention):
#  - API: 3000-3999
#  - Services: 4000-4999
#  - Mocks: 5000-5999
#  - Documentation: 7000-7999
#  - Websites: 9000-9999

version: '3.7'
services:
  redis:
    image: redis:6.2.5-alpine
    container_name: redis
    ports:
      - 6379:6379

  applications-service-api:
    image: node:16-alpine
    user: node
    container_name: applications-service-api
    environment:
      APP_APPLICATIONS_BASE_URL: http://forms-web-app:9004
      DOCS_API_PATH: /opt/app/packages/applications-service-api/api
      DOCUMENTS_HOST: https://nitestaz.planninginspectorate.gov.uk/wp-content/ipc/uploads/projects/
      DOCUMENTS_PER_PAGE: 20
      DOCUMENTS_SERVICE_API_URL: http://document-service-api:3000
      ENCRYPTION_SECRET_KEY: x!A%C*F-JaNdRgUkXp2s5v8y/B?E(G+K
      FILE_UPLOADS_PATH: /opt/app/uploads
      HAVING_YOUR_SAY_URL: https://applications-service-web-app.azurewebsites.net/
      LOGGER_LEVEL: debug
      MAGIC_LINK_DOMAIN: http://localhost:9004/
      MYSQL_USERNAME: pins
      MYSQL_PASSWORD: pins
      MYSQL_DATABASE: ipclive
      MYSQL_HOST: db
      MYSQL_PORT: 3306
      MYSQL_DIALECT: mysql
      NODE_ENV: local
      NI_API_HOST: ni-api-host.example.com
      NI_OAUTH_CLIENT_ID: some-client-id
      NI_OAUTH_CLIENT_SECRET: some-client-secret
      NI_OAUTH_USERNAME: some-username
      NI_OAUTH_PASSWORD: some-password
      PRELIMINARY_MEETING_URL: https://applications-service-web-app.azurewebsites.net/
      SERVER_SHOW_ERRORS: 'true'
      SRV_NOTIFY_API_KEY: applicationsservice-9b89eb93-3071-432c-9c6b-4e07dbda9071-101fa83a-8d08-40af-92b6-246b95074e5a
      SRV_NOTIFY_BASE_URL: https://api.notifications.service.gov.uk/
      SRV_NOTIFY_IP_REGISTRATION_CONFIRMATION_EMAIL_TO_IP: 830c9c01-1f81-4198-be72-11ab173c128a
      SRV_NOTIFY_MAGIC_LINK_EMAIL: 4ca6b93a-4c45-4abe-a8ea-69ba13c80915
      SRV_NOTIFY_SERVICE_ID: 9b89eb93-3071-432c-9c6b-4e07dbda9071
      TRIALIST_DATA_PATH: /opt/app/packages/applications-service-api/data/trialists.json
    ports:
      - 3000:3000
      - 9229:9229
    working_dir: /opt/app
    volumes:
      - ./package.json:/opt/app/package.json
      - ./node_modules:/opt/app/node_modules
      - ./packages/applications-service-api:/opt/app/packages/applications-service-api
      - ./uploads:/opt/app/uploads
    # command: npm run start:dev:debug --workspace=packages/applications-service-api
    command: npm run start:dev --workspace=packages/applications-service-api

  applications-web-app:
    image: node:16-alpine
    user: node
    container_name: applications-web-app
    environment:
      APPLICATIONS_SERVICE_API_URL: http://applications-service-api:3000
      DOCUMENTS_SERVICE_API_URL: http://document-service-api:3000
      FEATURE_REDIS_SESSION_STORE: 'true'
      FEATURE_SAVE_AND_EXIT_OPTION: 'false'
      FEATURE_SHOW_AFFECTED_AREA_SECTION: 'false'
      FEATURE_PROJECT_TIMELINE_LINK: 'false'
      FEATURE_ALLOW_DOCUMENT_LIBRARY: 'true'
      FEATURE_ALLOW_REPRESENTATION: 'true'
      FILE_UPLOAD_DEBUG: 'false'
      FILE_UPLOAD_MAX_FILE_SIZE_BYTES: 15000000
      FILE_UPLOAD_TMP_PATH: /tmp
      FILE_UPLOAD_USE_TEMP_FILES: 'true'
      GOOGLE_ANALYTICS_ID: G-X21W2S2FN3
      HOST_URL: http://localhost:9004/
      PDF_SERVICE_API_URL: http://pdf-service-api:3000
      PRIVATE_BETA_V1_ROUTES_ONLY: 'false'
      REDIS_URL: redis://redis:6379
      SESSION_KEY: some_secure_key_goes_here
      # please override this locally if using not using localhost or ip address to browse the site in dev.
      SUBDOMAIN_OFFSET: 0
      USE_SECURE_SESSION_COOKIES: 'false'
    working_dir: /opt/app
    volumes:
      - ./package.json:/opt/app/package.json
      - ./node_modules:/opt/app/node_modules
      - ./packages/common:/opt/app/packages/common
      - ./packages/forms-web-app:/opt/app/packages/forms-web-app
    command: npm run start:dev --workspace=packages/forms-web-app
    # if enabling debug, be sure to uncomment / expose the debug port below.
    # command: npm run start:dev:debug --workspace=packages/forms-web-app
    ports:
      - 9004:3000
    #  - 9229:9229
    links:
      - applications-service-api
    depends_on:
      - applications-service-api

  db:
    image: mysql
    platform: linux/x86_64
    container_name: ni_db
    cap_add:
      - SYS_NICE # CAP_SYS_NICE
    command: --default-authentication-plugin=mysql_native_password
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: ipclive
      MYSQL_USER: pins
      MYSQL_PASSWORD: pins
      MYSQL_ROOT_HOST: '%'
    ports:
      - 3306:3306
    volumes:
      - ./init:/docker-entrypoint-initdb.d

  adminer:
    image: adminer
    container_name: adminer
    restart: always
    ports:
      - 9000:8080
